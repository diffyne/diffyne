var Diffyne=(()=>{var e=Object.defineProperty,t=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,i={};((t,r)=>{for(var n in r)e(t,n,{get:r[n],enumerable:!0})})(i,{Diffyne:()=>v,default:()=>w});var s=class{constructor(e){this.id=e.id,this.componentClass=e.componentClass,this.componentName=e.componentName,this.element=e.element,this.state=e.state||{},this.serverState=JSON.parse(JSON.stringify(e.state||{})),this.fingerprint=e.fingerprint,this.signature=e.signature,this.vdom=e.vdom,this.errors={}}updateState(e){this.state={...this.state,...e},this.element.setAttribute("diff:state",JSON.stringify(this.state))}updateFingerprint(e){this.fingerprint=e,this.element.setAttribute("diff:fingerprint",e)}updateSignature(e){this.signature=e,this.element.setAttribute("diff:signature",e)}setErrors(e){this.errors=e||{}}clearErrors(){this.errors={}}isLazy(){return this.element.hasAttribute("data-diffyne-lazy")}markAsLoaded(){this.element.removeAttribute("data-diffyne-lazy"),this.element.setAttribute("data-diffyne-loaded","")}},o=class{constructor(){this.components=new Map}register(e,t){const r=new s(t);return this.components.set(e,r),r}get(e){return this.components.get(e)}has(e){return this.components.has(e)}remove(e){return this.components.delete(e)}getAll(){return Array.from(this.components.values())}clear(){this.components.clear()}};function a(e){try{return JSON.parse(e)}catch{return{}}}var l=class{constructor(e=!1){this.debug=e}log(...e){this.debug&&console.log("[Diffyne]",...e)}error(...e){console.error("[Diffyne Error]",...e)}},d=class{constructor(e,t,r,n){this.actionHandler=e,this.modelHandler=t,this.localStateHandler=r,this.fileUploadHandler=n}bind(e,t){e.hasAttribute("data-diffyne-delegated")||(e.setAttribute("data-diffyne-delegated","true"),this.bindClickEvents(e,t),this.bindChangeEvents(e,t),this.bindModelEvents(e,t),this.bindFileEvents(e,t),this.bindSubmitEvents(e,t),this.bindPollEvents(e,t))}bindClickEvents(e,t){e.addEventListener("click",r=>{const n=r.target.closest("[diff\\:click]");if(n&&e.contains(n)){const e=n.getAttribute("diff:click");this.actionHandler(t,e,r)}})}bindChangeEvents(e,t){e.addEventListener("change",r=>{const n=r.target.closest("[diff\\:change]");if(n&&e.contains(n)){const e=n.getAttribute("diff:change");this.actionHandler(t,e,r)}})}bindModelEvents(e,t){const r=e=>"checkbox"===e.type?e.checked:"radio"===e.type?e.checked?e.value:void 0:e.value;e.addEventListener("input",e=>{const n=e.target,i=this.findModelAttribute(n);if(i){const e=n.getAttribute(i.name),s=this.parseModifiers(i.name,e),o=r(n);if(s.live){if(!n._diffyneModelHandler){let e=e=>this.modelHandler(t,s.property,e);s.debounce&&(e=function(e,t){let r;return function(...n){clearTimeout(r),r=setTimeout(()=>e.apply(this,n),t)}}(e,s.debounce)),n._diffyneModelHandler=e}n._diffyneModelHandler(o)}else"SELECT"!==n.tagName&&"checkbox"!==n.type&&"radio"!==n.type&&this.localStateHandler(t,s.property,o)}}),e.addEventListener("change",e=>{const n=e.target;if("file"===n.type)return;const i=this.findModelAttribute(n);if(i){const e=n.getAttribute(i.name),s=this.parseModifiers(i.name,e),o=r(n);if("radio"===n.type&&!n.checked)return;s.lazy||"SELECT"===n.tagName||"checkbox"===n.type||"radio"===n.type?this.modelHandler(t,s.property,o):s.live||this.localStateHandler(t,s.property,o)}})}bindFileEvents(e,t){e.addEventListener("change",e=>{const r=e.target;if("file"!==r.type)return;const n=this.findModelAttribute(r);if(!n||!this.fileUploadHandler)return;const i=r.getAttribute(n.name),s=this.parseModifiers(n.name,i),o=r.files;if(o&&o.length>0){if(r.multiple){const e=Array.from(o).filter(e=>e&&e.size>0);e.length>0&&this.fileUploadHandler(t,s.property,e,!0)}else if(1===o.length){const e=o[0];e&&e.size>0&&this.fileUploadHandler(t,s.property,e,!1)}}})}bindSubmitEvents(e,t){e.addEventListener("submit",r=>{const n=r.target.closest("[diff\\:submit]");if(n&&e.contains(n)){r.preventDefault();const e=n.getAttribute("diff:submit");this.actionHandler(t,e,r)}})}bindPollEvents(e,t){e.querySelectorAll("[diff\\:poll]").forEach(e=>{if(e.hasAttribute("data-diffyne-poll-bound"))return;e.setAttribute("data-diffyne-poll-bound","true");const r=parseInt(e.getAttribute("diff:poll"))||2e3,n=e.getAttribute("diff:poll.action")||"refresh";setInterval(()=>{this.actionHandler(t,n)},r)})}findModelAttribute(e){return Array.from(e.attributes).find(e=>"diff:model"===e.name||e.name.startsWith("diff:model."))}parseModifiers(e,t){const r=e.split("."),n={property:t,live:r.includes("live"),lazy:r.includes("lazy"),debounce:null},i=r.findIndex(e=>"debounce"===e);return i>=0&&r[i+1]?n.debounce=parseInt(r[i+1]):n.live&&(n.debounce=150),n}},c=class{isSVGElement(e){return new Set(["svg","path","circle","rect","line","polyline","polygon","ellipse","g","defs","use","text","tspan","image","foreignobject","clippath","mask","pattern","lineargradient","radialgradient","stop","animate","animatetransform","animatemotion","title","desc","metadata"]).has(e.toLowerCase())}normalizeSVGAttributeName(e){return{viewbox:"viewBox",preserveaspectratio:"preserveAspectRatio",gradientunits:"gradientUnits",gradienttransform:"gradientTransform","xlink:href":"xlink:href","xlink:title":"xlink:title","stroke-linecap":"stroke-linecap","stroke-linejoin":"stroke-linejoin","stroke-width":"stroke-width","stroke-dasharray":"stroke-dasharray","stroke-dashoffset":"stroke-dashoffset","fill-rule":"fill-rule","clip-path":"clip-path","clip-rule":"clip-rule","text-anchor":"text-anchor","dominant-baseline":"dominant-baseline","baseline-shift":"baseline-shift","alignment-baseline":"alignment-baseline","font-family":"font-family","font-size":"font-size","font-weight":"font-weight","font-style":"font-style","text-decoration":"text-decoration","letter-spacing":"letter-spacing","word-spacing":"word-spacing","text-transform":"text-transform","writing-mode":"writing-mode","glyph-orientation-vertical":"glyph-orientation-vertical","glyph-orientation-horizontal":"glyph-orientation-horizontal"}[e.toLowerCase()]||e}vnodeToDOM(e,t=null){if(void 0!==e.x)return document.createTextNode(e.x);if(void 0!==e.m)return document.createComment(e.m);if(e.t){const r=e.t.toLowerCase(),n=this.isSVGElement(r),i=n?"http://www.w3.org/2000/svg":t,s=i?document.createElementNS(i,r):document.createElement(r),o=e.a||e.attributes||{};Object.entries(o).forEach(([e,t])=>{if(i){const r=this.normalizeSVGAttributeName(e);s.setAttributeNS(null,r,String(t))}else s.setAttribute(e,String(t))});const a=e.c||e.children||[],l=n?"http://www.w3.org/2000/svg":i;return a.forEach(e=>{s.appendChild(this.vnodeToDOM(e,l))}),s}if("text"===e.type)return document.createTextNode(e.text);if("element"===e.type){const r=e.tag.toLowerCase(),n=this.isSVGElement(r),i=n?"http://www.w3.org/2000/svg":t,s=i?document.createElementNS(i,r):document.createElement(r);Object.entries(e.attributes||{}).forEach(([e,t])=>{if(i){const r=this.normalizeSVGAttributeName(e);s.setAttributeNS(null,r,String(t))}else s.setAttribute(e,String(t))});const o=n?"http://www.w3.org/2000/svg":i;return(e.children||[]).forEach(e=>{s.appendChild(this.vnodeToDOM(e,o))}),s}return document.createTextNode("")}buildVDOM(e){return{tag:e.tagName.toLowerCase(),attrs:this.getAttributes(e),children:Array.from(e.childNodes).map(e=>e.nodeType===Node.TEXT_NODE?{type:"text",value:e.textContent}:e.nodeType===Node.ELEMENT_NODE?this.buildVDOM(e):null).filter(Boolean)}}getAttributes(e){const t={};return Array.from(e.attributes).forEach(e=>{t[e.name]=e.value}),t}},h=class{constructor(){this.converter=new c}applyPatches(e,t){if(!e)return void console.error("[PatchApplier] Content root is null, cannot apply patches");if(!t||0===t.length)return;if(this.isFullReplacement(t))return this.replaceContent(e,t[0]);const r=[],n=[];t.forEach(e=>{"remove"===this.expandType(e.t||e.type)?r.push(e):n.push(e)}),r.sort((e,t)=>{const r=e.p||e.path||[],n=t.p||t.path||[];for(let e=Math.min(r.length,n.length)-1;e>=0;e--)if(r[e]!==n[e])return n[e]-r[e];return n.length-r.length}),n.sort((e,t)=>{const r=e.p||e.path||[];return(t.p||t.path||[]).length-r.length});try{r.forEach((t,r)=>{try{this.applyPatch(e,t)}catch(e){throw console.error(`[PatchApplier] Failed to apply remove patch ${r}:`,t,e),e}}),n.forEach((t,r)=>{try{this.applyPatch(e,t)}catch(e){throw console.error(`[PatchApplier] Failed to apply patch ${r}:`,t,e),e}})}catch(e){throw console.error("[PatchApplier] Patch application failed:",e),e}}isFullReplacement(e){if(1!==e.length)return!1;const t=e[0],r=t.t||t.type,n=t.p||t.path;return!("c"!==r&&"create"!==r||0!==n?.length&&n)}replaceContent(e,t){const r=t.d||t.data,n=this.converter.vnodeToDOM(r.node);return e.parentNode.replaceChild(n,e),!0}applyPatch(e,t){const r=this.expandType(t.t||t.type),n=t.p||t.path||[],i=t.d||t.data;let s,o;if("create"===r&&n.length>0){const t=n.slice(0,-1);o=n[n.length-1],s=this.getNodeByPath(e,t)}else s=this.getNodeByPath(e,n),o=null;if(s)switch(r){case"create":this.patchCreate(s,i,o);break;case"remove":this.patchRemove(s);break;case"replace":this.patchReplace(s,i);break;case"update_text":this.patchUpdateText(s,i);break;case"update_attrs":this.patchUpdateAttrs(s,i);break;case"reorder":this.patchReorder(s,i)}else console.warn(`[PatchApplier] Target node not found for patch type ${r} at path ${n.join(".")}`)}expandType(e){return{c:"create",r:"remove",R:"replace",t:"update_text",a:"update_attrs",o:"reorder"}[e]||e}getNodeByPath(e,t){if(!t||0===t.length)return e;let r=e;for(const e of t){if(!r)return console.warn(`[PatchApplier] Node not found at path ${t.join(".")}, index ${e}`),null;const n=Array.from(r.childNodes).filter(e=>e.nodeType!==Node.TEXT_NODE||""!==e.textContent.trim());if(e<0||e>=n.length)return console.warn(`[PatchApplier] Index ${e} out of bounds (${n.length} children) at path ${t.join(".")}`),null;r=n[e]}return r}patchCreate(e,t,r=null){const n=this.converter.vnodeToDOM(t.node);if(null!==r){const t=Array.from(e.childNodes).filter(e=>e.nodeType!==Node.TEXT_NODE||""!==e.textContent.trim())[r];t?e.insertBefore(n,t):e.appendChild(n)}else e.appendChild(n)}patchRemove(e){if(e&&e.parentNode)try{e.parentNode.removeChild(e)}catch(t){console.error("[PatchApplier] Failed to remove node:",t,e)}else console.warn("[PatchApplier] Cannot remove node - node or parent is null")}patchReplace(e,t){const r=this.converter.vnodeToDOM(t.node);e.parentNode?.replaceChild(r,e)}patchUpdateText(e,t){e.nodeType===Node.TEXT_NODE&&(e.textContent=t.x||t.text)}patchUpdateAttrs(e,t){const r=t.s||t.set||{},n=t.r||t.remove||[];Object.entries(r).forEach(([t,r])=>{e.setAttribute(t,r),"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName||"value"!==t||(e.value=r),"INPUT"===e.tagName&&"checkbox"===e.type&&"checked"===t&&(e.checked=!0)}),n.forEach(t=>{e.removeAttribute(t),"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName||"value"!==t||(e.value=""),"INPUT"===e.tagName&&"checkbox"===e.type&&"checked"===t&&(e.checked=!1)})}patchReorder(e,t){t.moves.forEach(t=>{const r=e.childNodes[t.from];r&&e.insertBefore(r,e.childNodes[t.to])})}},p=class{constructor(e,t,r){this.config=e,this.logger=t,this.maxMessageSize=r,this.ws=null}async send(e){if("websocket"===this.config.transport){const t=JSON.stringify(e),r=new Blob([t]).size;return r>this.maxMessageSize?(this.logger&&this.logger.log(`[Diffyne] Message too large for WebSocket (${Math.round(r/1024)}KB), falling back to AJAX`),this.sendAjax(e)):this.sendWebSocket(e)}return this.sendAjax(e)}async sendAjax(e){const t=await fetch(`${this.config.endpoint}/update`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(e)}),r=await t.json();if(!t.ok||!r.s){const e=new Error(r.error||`HTTP ${t.status}: ${t.statusText}`);throw e.type=r.type,e.details=r,e}return r}sendWebSocket(e){return new Promise((t,r)=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void r(new Error("WebSocket not connected"));const n="req-"+Math.random().toString(36).substr(2,9);let i="diffyne.call";"update"===e.type?i="diffyne.update":"call"===e.type&&(i="diffyne.call");const s={event:i,data:{...e,requestId:n}},o=JSON.stringify(s),a=new Blob([o]).size;this.logger&&a>this.maxMessageSize&&this.logger.log(`[Diffyne WS] Sending large message (${Math.round(a/1024)}KB). Browser will fragment automatically.`);const l=e=>{try{const i=JSON.parse(e.data);if("diffyne.response"===i.event&&i.data?.requestId===n){this.ws.removeEventListener("message",l);const e=i.data;if(e.s)t(e);else{const t=new Error(e.error||"WebSocket request failed");t.type=e.type,t.details=e,r(t)}}}catch(e){}};this.ws.addEventListener("message",l),this.ws.send(o),setTimeout(()=>{this.ws.removeEventListener("message",l),r(new Error("Request timeout"))},3e4)})}connectWebSocket(e,t,r){const n=this.config.wsUrl||this.buildWebSocketUrl();this.ws=new WebSocket(n),this.ws.onopen=()=>{e&&e()},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);"diffyne.connected"===t.event&&this.logger.log("[Diffyne WS] Connected:",t.data),"diffyne.pong"===t.event&&this.logger.log("[Diffyne WS] Pong received")}catch(e){}},this.ws.onclose=()=>{t&&t(),setTimeout(()=>this.connectWebSocket(e,t,r),3e3)},this.ws.onerror=e=>{r&&r(e)}}buildWebSocketUrl(){return`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.hostname}:${this.config.wsPort||6001}`}async loadLazy(e,t,r,n){return(await fetch(`${this.config.endpoint}/lazy`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({componentClass:e,componentId:t,params:r,queryParams:n})})).json()}},f=class{show(e){this.findLoadingElements(e).forEach(e=>{const t=this.findLoadingAttribute(e);if(!t)return;const r=t.name.split(".");r.includes("class")?this.showLoadingClass(e,r):r.includes("remove")?this.showLoadingRemove(e,r):r.includes("attr")?this.showLoadingAttr(e,r):this.showLoadingDefault(e)})}hide(e){this.findLoadingElements(e).forEach(e=>{const t=this.findLoadingAttribute(e);if(!t)return;const r=t.name.split(".");r.includes("class")?this.hideLoadingClass(e,r):r.includes("remove")?this.hideLoadingRemove(e,r):r.includes("attr")?this.hideLoadingAttr(e,r):this.hideLoadingDefault(e)})}findLoadingElements(e){return Array.from(e.querySelectorAll("*")).filter(e=>Array.from(e.attributes).some(e=>e.name.startsWith("diff:loading")))}findLoadingAttribute(e){return Array.from(e.attributes).find(e=>e.name.startsWith("diff:loading"))}showLoadingClass(e,t){const r=t.indexOf("class");t[r+1]&&e.classList.add(t[r+1])}hideLoadingClass(e,t){const r=t.indexOf("class");t[r+1]&&e.classList.remove(t[r+1])}showLoadingRemove(e,t){const r=t.indexOf("remove");t[r+1]&&e.classList.remove(t[r+1])}hideLoadingRemove(e,t){const r=t.indexOf("remove");t[r+1]&&e.classList.add(t[r+1])}showLoadingAttr(e,t){const r=t.indexOf("attr");if(t[r+1]){const n=t[r+1],i=t[r+2]||"",s=e.getAttribute(n);null!==s&&e.setAttribute("data-diffyne-loading-original-"+n,s),e.setAttribute(n,i)}}hideLoadingAttr(e,t){const r=t.indexOf("attr");if(t[r+1]){const n=t[r+1],i="data-diffyne-loading-original-"+n;if(e.hasAttribute(i)){const t=e.getAttribute(i);e.setAttribute(n,t),e.removeAttribute(i)}else e.removeAttribute(n)}}showLoadingDefault(e){e.style.opacity="0.5",e.style.pointerEvents="none"}hideLoadingDefault(e){e.style.opacity="",e.style.pointerEvents=""}},g=class{display(e,t){this.clear(e),Object.entries(t).forEach(([t,r])=>{const n=e.querySelector(`[name="${t}"], [diff\\:model="${t}"]`);n&&(this.markFieldAsInvalid(n),this.showErrorMessage(e,n,t,r))})}clear(e){e.querySelectorAll(".diffyne-error").forEach(e=>{e.classList.remove("diffyne-error"),e.removeAttribute("aria-invalid")}),e.querySelectorAll("[diff\\:error]").forEach(e=>{e.textContent="",e.style.display="none"}),e.querySelectorAll(".diffyne-error-message").forEach(e=>{e.remove()})}markFieldAsInvalid(e){e.classList.add("diffyne-error"),e.setAttribute("aria-invalid","true")}showErrorMessage(e,t,r,n){const i=e.querySelector(`[diff\\:error="${r}"]`),s=Array.isArray(n)?n[0]:n;i?(i.textContent=s,i.style.display=""):this.createErrorElement(t,s)}createErrorElement(e,t){const r=document.createElement("span");r.className="diffyne-error-message",r.textContent=t,r.style.color="#ef4444",r.style.fontSize="0.875rem",r.style.marginTop="0.25rem",e.parentNode&&e.parentNode.insertBefore(r,e.nextSibling)}handle(e,t=!1){if(console.error("[Diffyne Error]",e),"validation_error"===e.type)return;let r="An error occurred";r="method_error"===e.type?`Method Error: ${e.message}`:"property_error"===e.type?`Property Error: ${e.message}`:"exception"===e.type&&e.details?`${e.details.exception}: ${e.message}\nFile: ${e.details.file}:${e.details.line}`:e.message||"Unknown error occurred",console.error("[Diffyne Error Details]",{type:e.type,message:e.message,details:e.details}),t&&alert(r)}},u=class{sync(e,t){this.findModelInputs(e).forEach(e=>{if("file"===e.type)return;const r=this.findModelAttribute(e);if(!r)return;const n=e.getAttribute(r.name),i=this.parseModifiers(r.name,n).property;t.hasOwnProperty(i)&&this.syncInput(e,t[i])})}findModelInputs(e){return Array.from(e.querySelectorAll("*")).filter(e=>Array.from(e.attributes).some(e=>"diff:model"===e.name||e.name.startsWith("diff:model.")))}findModelAttribute(e){return Array.from(e.attributes).find(e=>"diff:model"===e.name||e.name.startsWith("diff:model."))}syncInput(e,t){if("file"!==e.type)if("INPUT"===e.tagName)if("checkbox"===e.type){const r=Boolean(t);e.checked!==r&&(e.checked=r)}else if("radio"===e.type){const r=e.value===String(t);e.checked!==r&&(e.checked=r)}else{const r=t??"";e.value!==r&&(e.value=r)}else if("TEXTAREA"===e.tagName){const r=t??"";e.value!==r&&(e.value=r)}else if("SELECT"===e.tagName){const r=t??"";e.value!==r&&(e.value=r)}}parseModifiers(e,t){const r=e.split(".");return{property:t,live:r.includes("live"),lazy:r.includes("lazy")}}},m=class{constructor(e,t){this.registry=e,this.logger=t,this.listeners=new Map}on(e,t,r){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push({componentId:e,handler:r}),this.logger.log(`Registered listener for '${t}' on component ${e}`)}dispatchEvents(e){e&&0!==e.length&&e.forEach(e=>{const{name:t,params:r,to:n,self:i}=e;this.logger.log(`Dispatching event '${t}'`,{params:r,to:n,self:i});(this.listeners.get(t)||[]).forEach(e=>{if(!(n&&n.length>0)||n.includes(e.componentId))try{e.handler(...r)}catch(e){this.logger.error(`Error in event listener for '${t}':`,e)}})})}dispatchBrowserEvents(e){e&&0!==e.length&&e.forEach(e=>{const{name:t,data:r}=e;this.logger.log(`Dispatching browser event '${t}'`,r);const n=new CustomEvent(t,{detail:r,bubbles:!0,cancelable:!0});window.dispatchEvent(n)})}bindEventListeners(e,t){e.querySelectorAll("[diff\\:on]").forEach(e=>{Array.from(e.attributes).forEach(e=>{if(e.name.startsWith("diff:on.")){const r=e.name.substring(8),n=e.value;this.on(t,r,(...e)=>{this.logger.log(`Event '${r}' received by component ${t}, calling ${n}`);const i=this.registry.get(t);if(i&&i.element){const r=new CustomEvent("diff:action",{detail:{componentId:t,method:n,params:e}});i.element.dispatchEvent(r)}}),this.logger.log(`Bound event listener: ${r} -> ${n} on component ${t}`)}})})}removeListenersForComponent(e){this.listeners.forEach((t,r)=>{const n=t.filter(t=>t.componentId!==e);n.length>0?this.listeners.set(r,n):this.listeners.delete(r)})}clear(){this.listeners.clear()}},y=class{constructor(e){this.config=e}async uploadFile(e,t,r,n=null){const i=new FormData;return i.append("file",e),i.append("componentId",t),i.append("property",r),i.append("_token",function(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""}()),new Promise((e,t)=>{const r=new XMLHttpRequest;n&&r.upload.addEventListener("progress",e=>{e.lengthComputable&&n(e.loaded/e.total*100)}),r.addEventListener("load",()=>{if(r.status>=200&&r.status<300)try{const n=JSON.parse(r.responseText);n.success?e(n):t(new Error(n.error||"Upload failed"))}catch(e){t(new Error("Invalid response"))}else try{const e=JSON.parse(r.responseText);t(new Error(e.error||"Upload failed"))}catch(e){t(new Error("Upload failed"))}}),r.addEventListener("error",()=>t(new Error("Network error"))),r.addEventListener("abort",()=>t(new Error("Upload aborted")));const s=this.config.endpoint.replace(/\/$/,"");r.open("POST",`${s}/upload`),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.send(i)})}},v=class{constructor(e={}){this.config={transport:e.transport||"ajax",wsUrl:e.wsUrl||"ws://localhost:8080/diffyne",endpoint:e.endpoint||"/_diffyne",debug:e.debug||!1,maxMessageSize:e.maxMessageSize||1048576,...e},this.logger=new l(this.config.debug),this.registry=new o,this.transport=new p(this.config,this.logger,this.maxMessageSize),this.patchApplier=new h,this.vNodeConverter=new c,this.loadingService=new f,this.errorService=new g,this.modelSync=new u,this.eventManager=new m(this.registry,this.logger),this.fileUpload=new y(this.config),this.pendingRequests=new Map,this.requestSequence=new Map,this.eventBinder=new d((e,t,r)=>this.handleAction(e,t,r),(e,t,r)=>this.handleModelUpdate(e,t,r),(e,t,r)=>this.updateLocalState(e,t,r),(e,t,r,n)=>this.handleFileUpload(e,t,r,n)),this.init()}init(){this.logger.log("Initializing Diffyne..."),"websocket"===this.config.transport&&this.transport.connectWebSocket(()=>this.logger.log("WebSocket connected"),()=>this.logger.log("WebSocket disconnected"),e=>this.logger.error("WebSocket error:",e)),this.hydrateComponents(),setTimeout(()=>this.loadLazyComponents(),100),this.observeDOMChanges(),document.addEventListener("diff:action",e=>{const{componentId:t,method:r,params:n}=e.detail;this.handleAction(t,r,e)}),window.addEventListener("popstate",()=>{this.logger.log("Browser navigation detected, reloading page"),window.location.reload()})}hydrateComponents(){document.querySelectorAll("[diff\\:id]").forEach(e=>{e.hasAttribute("data-diffyne-lazy")||this.hydrateComponent(e)})}hydrateComponent(e){const t=e.getAttribute("diff:id"),r=e.getAttribute("diff:class"),n=e.getAttribute("diff:name"),i=a(e.getAttribute("diff:state")||"{}"),s=e.getAttribute("diff:fingerprint"),o=e.getAttribute("diff:signature"),l=a(e.getAttribute("diff:listeners")||"{}");this.registry.register(t,{id:t,componentClass:r,componentName:n,element:e,state:i,fingerprint:s,signature:o,vdom:this.vNodeConverter.buildVDOM(e)});const d=this.registry.get(t);d&&(d.serverState=JSON.parse(JSON.stringify(i))),this.modelSync.sync(e,i),this.eventBinder.bind(e,t),this.eventManager.bindEventListeners(e,t),l&&Object.keys(l).length>0&&this.registerServerEventListeners(t,l),this.logger.log(`Hydrated component: ${t} (${n})`)}loadLazyComponents(){document.querySelectorAll("[data-diffyne-lazy]").forEach(e=>this.loadLazyComponent(e))}async loadLazyComponent(e){const t=e.getAttribute("diff:id"),r=e.getAttribute("diff:class"),n=e.getAttribute("diff:name"),i=a(e.getAttribute("diff:params")||"{}"),s=function(){const e=new URLSearchParams(window.location.search),t={};for(const[r,n]of e)t[r]=n;return t}();this.logger.log(`Loading lazy component: ${t} (${n})`);try{const o=await this.transport.loadLazy(r,t,i,s);if(o.success){e.setAttribute("diff:state",JSON.stringify(o.state)),e.setAttribute("diff:fingerprint",o.fingerprint),e.removeAttribute("data-diffyne-lazy"),e.setAttribute("data-diffyne-loaded",""),e.innerHTML=o.html,this.registry.register(t,{id:t,componentClass:r,componentName:n,element:e,state:o.state,fingerprint:o.fingerprint,vdom:this.vNodeConverter.buildVDOM(e)});const i=this.registry.get(t);i&&(i.serverState=JSON.parse(JSON.stringify(o.state))),this.modelSync.sync(e,o.state),this.eventBinder.bind(e,t),this.eventManager.bindEventListeners(e,t),o.eventListeners&&this.registerServerEventListeners(t,o.eventListeners),this.logger.log(`Lazy component loaded: ${t} (${n})`)}else e.innerHTML=`<div style="color: red; padding: 1rem;">Failed to load component: ${o.error}</div>`}catch(t){this.logger.error("Error loading lazy component:",t),e.innerHTML='<div style="color: red; padding: 1rem;">Error loading component</div>'}}async handleAction(e,t,r=null){const[n,...i]=function(e){const t=e.match(/^(\w+)(?:\((.*)\))?$/);if(!t)return[e];const r=t[1],n=t[2];return n?[r,...n.split(",").map(e=>(e=e.trim()).startsWith("'")||e.startsWith('"')?e.slice(1,-1):isNaN(e)?"true"===e||"false"!==e&&e:Number(e))]:[r]}(t);this.logger.log(`Action: ${n}`,i),await this.callMethod(e,n,i)}async handleModelUpdate(e,t,r){this.logger.log(`Model update: ${t} = ${r}`),await this.updateProperty(e,t,r)}updateLocalState(e,t,r){const n=this.registry.get(e);n&&(n.state[t]=r,this.logger.log(`Local state update: ${t} = ${r}`))}async handleFileUpload(e,t,r,n=!1){const i=this.registry.get(e);if(i)try{if(this.loadingService.show(i.element),n&&Array.isArray(r)){const n=[];for(const i of r)try{const r=await this.fileUpload.uploadFile(i,e,t);r.success&&n.push(r.identifier)}catch(e){this.logger.error(`Failed to upload file ${i.name}:`,e)}if(n.length>0){const r=i.state[t],s=Array.isArray(r)?r:[];await this.updateProperty(e,t,[...s,...n])}}else if(!n){const n=await this.fileUpload.uploadFile(r,e,t);if(n.success){const r=i.state[t];Array.isArray(r)?await this.updateProperty(e,t,[...r,n.identifier]):await this.updateProperty(e,t,n.identifier)}}}catch(e){this.errorService.display(i.element,{[t]:[e.message||"Upload failed"]})}finally{this.loadingService.hide(i.element)}}async callMethod(e,t,r=[]){const n=this.registry.get(e);if(!n)return;this.cancelPendingRequest(e),this.loadingService.show(n.element);const i=JSON.parse(JSON.stringify(n.state)),s=new AbortController,o=this.getNextRequestId(e);this.pendingRequests.set(e,{controller:s,requestId:o});try{const s=await this.transport.send({type:"call",componentId:e,componentClass:n.componentClass,method:t,params:r,state:i,fingerprint:n.fingerprint,signature:n.signature});this.isRequestValid(e,o)&&this.processResponse(e,s,o,"call")}catch(t){"AbortError"!==t.name&&this.isRequestValid(e,o)&&this.handleError(e,t)}finally{this.isRequestValid(e,o)&&this.loadingService.hide(n.element),this.pendingRequests.delete(e)}}async updateProperty(e,t,r){const n=this.registry.get(e);if(!n)return;this.cancelPendingRequest(e);const i=n.serverState||n.state,s=n.signature,o=t,a=new AbortController,l=this.getNextRequestId(e);this.pendingRequests.set(e,{controller:a,requestId:l,updatingProperty:o});try{const a=await this.transport.send({type:"update",componentId:e,componentClass:n.componentClass,property:t,value:r,state:i,fingerprint:n.fingerprint,signature:s});this.isRequestValid(e,l)&&this.processResponse(e,a,l,"update",o)}catch(t){"AbortError"!==t.name&&this.isRequestValid(e,l)&&this.handleError(e,t)}finally{this.pendingRequests.delete(e)}}processResponse(e,t,r=null,n="call",i=null){const s=this.registry.get(e);if(!s)return;if(r&&!this.isRequestValid(e,r))return void this.logger.log(`Ignoring stale response for ${e} (request ${r})`);const o=void 0!==t.s?t.s:t.success;if(o&&t.redirect){const e=t.redirect.url;return void(void 0===t.redirect.spa||t.redirect.spa?this.spaNavigate(e):window.location.href=e)}const a=t.c||t.component;if(!o||!a)return;const l=a.p||a.patches||[],d=a.st||a.state,c=a.f||a.fingerprint,h=a.sig||a.signature,p=a.e||a.errors,f=a.q||a.queryString;this.logger.log(`Applying ${l.length} patches to ${e}`,l);const g=s.element.firstElementChild;if(g)try{this.patchApplier.applyPatches(g,l)}catch(t){return this.logger.error(`Failed to apply patches to ${e}:`,t),void this.fallbackRerender(e,a)}if(d)if("update"===n&&i){const e={...s.state};d.hasOwnProperty(i)&&(e[i]=d[i]),s.updateState(e),s.serverState=JSON.parse(JSON.stringify(d));const t=d[i];if(void 0!==t){this.modelSync.findModelInputs(s.element).forEach(e=>{if("file"===e.type)return;const r=this.modelSync.findModelAttribute(e);if(r){e.getAttribute(r.name)===i&&this.modelSync.syncInput(e,t)}})}}else s.updateState(d),s.serverState=JSON.parse(JSON.stringify(d)),this.modelSync.sync(s.element,d);c&&s.updateFingerprint(c),h&&s.updateSignature(h),f&&function(e){const t=new URL(window.location);Object.keys(e).forEach(r=>{null!==e[r]&&""!==e[r]&&void 0!==e[r]?t.searchParams.set(r,e[r]):t.searchParams.delete(r)}),window.history.pushState({},"",t)}(f),p?(s.setErrors(p),this.errorService.display(s.element,p)):(s.clearErrors(),this.errorService.clear(s.element)),t.events&&this.eventManager.dispatchEvents(t.events),t.browserEvents&&this.eventManager.dispatchBrowserEvents(t.browserEvents)}handleError(e,t){const r=this.registry.get(e),n=t.details?.errors||t.details?.details?.errors;this.logger.log("handleError called:",{componentId:e,errorType:t.type,hasDetails:!!t.details,hasErrors:!!n,errors:n}),"validation_error"===t.type&&n?r?(this.logger.log("Displaying validation errors:",n),r.setErrors(n),this.errorService.display(r.element,n)):this.logger.error("Component not found for validation errors:",e):this.errorService.handle(t,this.config.debug)}observeDOMChanges(){new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){e.querySelectorAll("[diff\\:id]").forEach(e=>this.hydrateComponent(e))}})})}).observe(document.body,{childList:!0,subtree:!0})}async spaNavigate(e){try{this.logger.log("SPA navigation to:",e);const t=await fetch(e,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.text(),n=(new DOMParser).parseFromString(r,"text/html");document.title=n.title,document.body.innerHTML=n.body.innerHTML,window.history.pushState({},"",e),this.registry.clear(),this.hydrateComponents(),this.logger.log("SPA navigation completed")}catch(t){this.logger.error("SPA navigation failed, falling back to full page reload:",t),window.location.href=e}}registerServerEventListeners(e,t){for(const[r,n]of Object.entries(t))n.forEach(t=>{this.eventManager.on(e,r,async(...n)=>{this.logger.log(`Event '${r}' triggered on component ${e}, calling ${t}`),await this.callMethod(e,t,n)})});this.logger.log(`Registered ${Object.keys(t).length} event listeners for component ${e}`)}cancelPendingRequest(e){const t=this.pendingRequests.get(e);t&&t.controller&&(t.controller.abort(),this.pendingRequests.delete(e),this.logger.log(`Cancelled pending request for ${e}`))}getNextRequestId(e){const t=(this.requestSequence.get(e)||0)+1;return this.requestSequence.set(e,t),t}isRequestValid(e,t){return t>=(this.requestSequence.get(e)||0)}fallbackRerender(e,t){this.registry.get(e)&&(this.logger.log(`Fallback: Re-rendering component ${e} due to patch failure`),this.logger.error(`Patch application failed for ${e}. Consider using keys for list items.`))}};"undefined"!=typeof window&&(window.Diffyne=v,document.addEventListener("DOMContentLoaded",()=>{const e=window.diffyneConfig||{};window.diffyne=new v(e)}));var b,w=v;return b=i,((i,s,o,a)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let l of r(s))n.call(i,l)||l===o||e(i,l,{get:()=>s[l],enumerable:!(a=t(s,l))||a.enumerable});return i})(e({},"__esModule",{value:!0}),b)})();